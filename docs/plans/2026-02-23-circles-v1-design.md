# Circles v1 Design

Date: 2026-02-23
Branch: feature/social
Status: Approved

## Scope

Circles (branded "Crop Circles") are persistent small groups of up to 30 members sharing a weekly leaderboard and activity feed. This is the core social retention mechanism for the 30 Plant Point Challenge.

### In scope

- Database tables: `circle`, `circle_member`, `circle_activity`, `circle_activity_reaction`
- Streak columns on `member` table (`current_streak`, `best_streak`)
- SQL views for weekly and all-time leaderboard scoring
- Database triggers for feed events
- 6-char invite codes + deep link join flow
- Bottom nav change: "Board" becomes "Circles"
- Routes: `/circles`, `/circles/[id]`, `/circles/create`, `/circles/[id]/settings`, `/join/[code]`
- Competitive leaderboard (weekly + all-time tabs)
- Ghost handling (14-day inactive fade)
- Activity feed (last 20 events, single emoji reactions)
- Admin controls (rename, remove member, transfer admin, delete)
- Leave circle for non-admins
- 30-member cap
- Onboarding banner (dismissible, one-time)

### Deferred

- Circle chat (text, reactions, meal photo shares)
- Cooperative mode (shared goal progress bar)
- Supabase Realtime (WebSocket subscriptions)
- Households as social unit in Circles
- Tier/premium gating
- Push notifications

## Architecture

Server-side aggregation via Supabase. Leaderboard scores computed by SQL views. Activity feed events generated by database triggers on `plant_log` inserts. Data refreshes on page load / pull-to-refresh (no realtime).

## Database Schema

### Tables

```sql
-- Circles
create table circle (
  id              uuid primary key default gen_random_uuid(),
  name            text not null,
  invite_code     text unique not null,  -- 6 chars, uppercase alphanumeric (no 0/O/1/I/L)
  admin_id        uuid not null references member(id),
  week_start_day  smallint not null default 1,  -- 1=Monday
  created_at      timestamptz not null default now()
);

-- Circle membership
create table circle_member (
  id              uuid primary key default gen_random_uuid(),
  circle_id       uuid not null references circle(id) on delete cascade,
  member_id       uuid not null references member(id) on delete cascade,
  joined_at       timestamptz not null default now(),
  last_active_at  timestamptz,
  unique(circle_id, member_id)
);

-- Activity feed
create table circle_activity (
  id              uuid primary key default gen_random_uuid(),
  circle_id       uuid not null references circle(id) on delete cascade,
  member_id       uuid references member(id),  -- nullable for system events
  event_type      text not null,  -- 'hit_30', 'new_lifetime_plant', 'streak_milestone', 'member_joined'
  payload         jsonb,
  created_at      timestamptz not null default now()
);

-- Emoji reactions on feed events
create table circle_activity_reaction (
  id              uuid primary key default gen_random_uuid(),
  activity_id     uuid not null references circle_activity(id) on delete cascade,
  member_id       uuid not null references member(id) on delete cascade,
  emoji           text not null,  -- constrained to: fire, clap, flex, seedling, party, heart
  created_at      timestamptz not null default now(),
  unique(activity_id, member_id)  -- one reaction per person per event
);

-- Streak columns on existing member table
alter table member add column current_streak integer not null default 0;
alter table member add column best_streak integer not null default 0;
```

### Views

```sql
-- Weekly leaderboard
create view circle_weekly_score as
select
  cm.circle_id,
  cm.member_id,
  m.display_name,
  m.avatar_emoji,
  pl.week_start,
  coalesce(sum(pl.points), 0) as total_points,
  cm.last_active_at,
  (cm.last_active_at is null or cm.last_active_at < now() - interval '14 days') as is_ghost
from circle_member cm
join member m on m.id = cm.member_id
left join plant_log pl on pl.member_id = cm.member_id
group by cm.circle_id, cm.member_id, m.display_name, m.avatar_emoji, pl.week_start, cm.last_active_at;

-- All-time leaderboard
create view circle_alltime_score as
select
  cm.circle_id,
  cm.member_id,
  m.display_name,
  m.avatar_emoji,
  coalesce(sum(pl.points), 0) as total_points,
  count(distinct pl.week_start) as weeks_active,
  case when count(distinct pl.week_start) > 0
    then coalesce(sum(pl.points), 0) / count(distinct pl.week_start)
    else 0
  end as avg_weekly,
  cm.last_active_at,
  (cm.last_active_at is null or cm.last_active_at < now() - interval '14 days') as is_ghost
from circle_member cm
join member m on m.id = cm.member_id
left join plant_log pl on pl.member_id = cm.member_id
group by cm.circle_id, cm.member_id, m.display_name, m.avatar_emoji, cm.last_active_at;
```

### Triggers

1. **on_plant_log_insert**: Updates `circle_member.last_active_at` for all circles the member belongs to. Checks weekly total — if it just crossed 30, inserts `hit_30` activity (deduplicated per member/circle/week). Checks if this plant has ever been logged before by this member — if not, inserts `new_lifetime_plant` activity.

2. **on_plant_log_insert (streak)**: On first log of a new week, checks if previous week had >=30 points. If yes, increments `member.current_streak` and updates `best_streak` if needed. If `current_streak` hits a threshold (4, 8, 12, 26, 52), inserts `streak_milestone` activity into all member's circles.

3. **on_circle_member_insert**: Inserts `member_joined` activity.

### RLS Policies

- `circle`: SELECT for members of the circle (via `circle_member`). INSERT for authenticated users. UPDATE/DELETE for admin only.
- `circle_member`: SELECT for members of the same circle. INSERT via `join_circle` RPC. DELETE for circle admin or self.
- `circle_activity`: SELECT for members of the circle. INSERT by triggers only.
- `circle_activity_reaction`: SELECT for members of the circle. INSERT/DELETE for self.

## Invite Code & Join Flow

- 6-char code from charset: `ABCDEFGHJKMNPQRSTUVWXYZ23456789` (no 0/O/1/I/L)
- Generated on Circle creation; collision check + retry
- Deep link: `/join/{code}`
- `join_circle(invite_code, member_id)` RPC: validates code, checks cap < 30, inserts member, returns circle
- `/join/[code]` page: checks auth, joins, redirects to `/circles/[id]`. Unauthenticated users redirect to `/auth?join={code}` and auto-join after signup.

## Routes & Navigation

- Bottom nav: "Board" label → "Circles", same trophy icon, links to `/circles`
- `/circles` — list of user's circles + create/join buttons + empty state
- `/circles/[id]` — detail view with Leaderboard and Activity tabs
- `/circles/create` — creation form + share prompt after
- `/circles/[id]/settings` — admin controls
- `/join/[code]` — deep link handler

## Leaderboard

- Weekly tab (default): ranked by `total_points` desc for current `week_start`. Ties broken by earliest log timestamp.
- All-time tab: ranked by cumulative `total_points`. Ties broken by higher `avg_weekly`.
- Top 3 get podium treatment (existing visual pattern). Rows 4+ standard.
- Ghost members (is_ghost=true) sort to bottom with faded opacity and "inactive" badge.

## Activity Feed

- Last 20 events, reverse-chronological
- Compact cards: avatar emoji, member name, event text, relative timestamp
- Single emoji reaction per event per user (tap to toggle from 6 options)
- Reaction emoji set: fire, clap, flex, seedling, party, heart
- Data loads on page open; pull-to-refresh

### Event types

| Event | Trigger | Feed text |
|-------|---------|-----------|
| `hit_30` | Weekly total crosses 30 | "{name} hit 30 this week!" |
| `new_lifetime_plant` | First ever log of this plant | "{name} tried {plant} for the first time" |
| `streak_milestone` | Streak hits 4/8/12/26/52 | "{name} is on a {N}-week streak!" |
| `member_joined` | New circle_member row | "{name} joined the circle" |

## Ghost Handling

- Inactive = `last_active_at` is null or older than 14 days
- Rendered with faded opacity + "inactive" badge
- Sorted to bottom of leaderboard
- Silently reappear on next plant_log

## Admin Controls

- Rename circle
- Remove member (not self)
- Transfer admin to another member
- Delete circle (typed confirmation required)
- Non-admins: leave circle (admin must transfer first)

## Onboarding

- Dismissible banner on home page after signup: "Start a Crop Circle and invite your friends"
- Persisted in localStorage as `dismissed_circle_prompt`
- Shown once, never again after dismissal

## Design Language

- "Crop Circles" branding throughout (nav label, headers, empty states)
- Matches existing design system: brand colors, Fraunces headings, DM Sans body, glassmorphic cards, botanical illustration accents
- Circle detail page follows the same visual patterns as the existing leaderboard
